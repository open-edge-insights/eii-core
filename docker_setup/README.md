# Docker setup of ETA solution:

## Pre-requisities:
1. Have the Go dev env setup on your host machine. Refer **README.md** to have it setup if not done already.
2. Install latest docker cli/docker daemon by following [this](https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-docker-ce). Follow **Install using the repository** and **Install Docker CE** sections there. Also, follow the manage docker as a non-root user section at [post install](https://docs.docker.com/install/linux/linux-postinstall/) to run docker without sudo
3. Configure proxy settings for docker client to connect to internet and for containers to access internet by following [this](https://docs.docker.com/network/proxy/).If you still see issues of not being able to access internet from container, please update the /etc/resolv.conf. The changes may go away after system restart, should be brought in back.
on your host system with the following content:
    `
    # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
    #     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
    nameserver 10.248.2.1
    nameserver 10.223.45.36
    nameserver 172.30.90.4
    search iind.intel.com
    `
4. Configure proxy settings for docker daemon by following the steps at [this](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy)
5. Since we are using host network namespace for containers, please make sure that individual processes/modules of ETA are stopped on host system. If they are running, the containers will fail to launch as the ports are already in use. To see if a specific port is in use, one can use this cmd:
**sudo fuser <port>/tcp** - it will tell the process ID using it.
6. Run all the docker scripts from $GOPATH/src/<youriapocrepofolder>/docker_setup/scripts
7. In dockerized environment, it is observed that more points are received by kapacitor from influxdb. This is due to more subscriptions set on "datain" database. Please make sure to drop "datain" database before trying the docker setup OR drop the subscription. Eg: **drop subscription "kapacitor-65c392d7-6ef7-46f8-97c2-e5eeb7094c12" on "_internal"."monitor"** for _internal database.

## Steps to setup ETA solution on dev system

### 1. Run dependency images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    ```sh
    sudo -E env "PATH=$PATH" ./run_dependency_images.sh
    ```
    > Note: To check if all the dependency containers are running, use cmd: **docker ps** 
### 2. Build ETA images (one time task unless you change something in Dockerfile of ETA images)
    ```sh
    sudo -E env "PATH=$PATH" ./build_eta_images.sh
    ```
    > Note: To check if all the ETA images are built successfully, use cmd: **docker images|grep ia** 
### 3. Run ETA images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    ```sh
    sudo -E env "PATH=$PATH" ./run_eta_images.sh
    ```
    > Note: To check if all the eta containers are running, use cmd: **docker ps** 

## Steps to setup ETA solution on factory system

**Pre-requisite:**
    Have the ETA images stored as tarballs from dev system
    ```sh
    sudo -E env "PATH=$PATH" ./deploy/save_eta_images.sh
    ```
### 1. Load ETA images (Input here is the ETA images tarballs)
    ```sh
    sudo -E env "PATH=$PATH" ./deploy/load_eta_images.sh
    ```
### 2. Run dependency images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    ```sh
    sudo -E env "PATH=$PATH" ./run_dependency_images.sh
    ```
### Run ETA images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    ```sh
    sudo -E env "PATH=$PATH" ./run_eta_images.sh
    ```

> Note:
> 1. ETA containers are: DataAgent(ia_data_agent), Video Ingestion(ia_video_ingestion), Classifier(ia_data_analytics) and NATS client
> 2. Dependency containers are: Influxdb(influx_cont), Redis(redis_cont), nats (nats_cont), postgres(postgres_cont), mosquitto (mosquitto_cont)
> 3. Few useful docker commands:
>   * **docker ps** - check running containers
>   * **docker ps -a** - check running and stopped containers
>   * **docker stop $(docker ps -a -q)** - stops all the containers
>   * **docker rm $(docker ps -a -q)** - removes all the containers. Useful when you run into issue of already container is in use.
> 4. If you want to run the docker images separately i.e, one by one, just do **source setenv.sh** script on the terminal and then copy & run > the individual **docker run** container commands with **-it** switch instead of **-d** to get to see the entrypoint program output inside
> the container.
> 4. **Known issues as of now**: 
>    * Logs of container may not be fully available at /var/lib/eta/logs location for few containers like **ia_data_analytics_cont**.
>      Best way to check logs is to use command: **docker logs <contname>**
