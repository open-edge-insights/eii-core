# Docker compose setup of ETA solution:

## Pre-requisities:
1. Install latest docker cli/docker daemon by following [this](https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-docker-ce). Follow **Install using the repository** and **Install Docker CE (follow first 2 steps)** sections there. Also, follow the manage docker as a non-root user section at [post install](https://docs.docker.com/install/linux/linux-postinstall/) to run docker without sudo
2. Configure proxy settings for docker client to connect to internet and for containers to access internet by following [this](https://docs.docker.com/network/proxy/). One can copy the below json object to ~/.docker/config.json (**Note**: `Depending on the geo location where the system is setup, please use the proxy settings of that geo`):

    ```
    {
        "proxies":
            {
                "default":
                {
                    "httpProxy": "http://proxy.iind.intel.com:911",
                    "httpsProxy": "http://proxy.iind.intel.com:911",
                    "noProxy": "127.0.0.1,localhost,*.intel.com"
                }
            }
    }
    ```

3. Configure proxy settings for docker daemon by following the steps at [this](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy). Use the values for http proxy and https proxy as used above (**Note**: `Depending on the geo location where the system is setup, please use the proxy settings of that geo`)

4. If you still see issues of not being able to access internet from container, please update the /etc/resolv.conf. The changes may go away after system restart, should be brought in back. Please follow the instructions below to have /etc/resolv.conf configured correctly:

    ```
    A. Ubuntu 16.04 and earlier

        For Ubuntu 16.04 and earlier, /etc/resolv.conf was dynamically generated by NetworkManager.

        Comment out the line dns=dnsmasq (with a #) in /etc/NetworkManager/NetworkManager.conf

        Restart the NetworkManager to regenerate /etc/resolv.conf :
        sudo systemctl restart network-manager

        Verify on the host: cat /etc/resolv.conf

    B. Ubuntu 18.04 and later

        Ubuntu 18.04 changed to use systemd-resolved to generate /etc/resolv.conf. Now by default it uses a local DNS cache 127.0.0.53. That will not work inside a container, so Docker will default to Google's 8.8.8.8 DNS server, which may break for people behind a firewall.

        /etc/resolv.conf is actually a symlink (ls -l /etc/resolv.conf) which points to /run/systemd/resolve/stub-resolv.conf (127.0.0.53) by default in Ubuntu 18.04.

        Just change the symlink to point to /run/systemd/resolve/resolv.conf, which lists the real DNS servers:
        sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf

        Verify on the host: cat /etc/resolv.conf
    ```
4. Install docker-compose by following this [link](https://docs.docker.com/compose/install/#install-compose)

5. In dockerized environment, it is observed that more points are received by kapacitor from influxdb if at all the bare metal setup is tried out earlier. This is due to more subscriptions set on "datain" database. Please make sure to drop "datain" database before trying the docker setup OR drop the subscription. Eg: **drop subscription "kapacitor-65c392d7-6ef7-46f8-97c2-e5eeb7094c12" on "_internal"."monitor"** for _internal database.

6. Copy all the video files from "\\Vmspfsfsbg01\qsd_sw_ba\FOG\Validation\validation_videos" in the test_videos folder under the project root directory

8. Clone the a locallly maintained kapacitor repository inside the iapoc_elephanttrunkarch folder in the name of "kapacitor_repo". For example
   `git clone https://<userid>@git-amr-2.devtools.intel.com/gerrit/iapoc-kapacitor`

   **Note**: Better to obtain the command from gerrit/teamforge itself as the username needs to be changed if you plan to use above command

## Steps to setup ETA solution on dev system (scripts hould be executed from `$GOPATH/src/<youriapocrepofolder>/docker_setup/scripts` directory)

1. Build and run dependency and ETA images as per the dependency order (one time task unless you change something in Dockerfile of ETA images)
    
    ```sh
    sudo ./compose_startup.sh | tee compose_startup.txt
    ```
    
    > **Note**: 
    1. To check if all the ETA images are built successfully, use cmd: **docker images|grep ia** and all containers are running, use cmd: **docker ps** (`one should see all the dependency containers and ETA containers up and running`). If you see issues where the build is failing due to non-reachability to Internet, please ensure you have correctly configured proxy settings and restarted docker service. Even after doing this, if you are running into the same issue, please add below instrcutions to all the dockerfiles in `docker_setup\dockerfiles` at the top after the LABEL instruction and retry the building ETA images:
    ```
        ENV http_proxy http://proxy.iind.intel.com:911
        ENV https_proxy http://proxy.iind.intel.com:911
    ```

2. Triggering camera ON message to ia_video_ingestion container (`This step is needed only when working with basler's camera`)

    ```sh
    docker exec -it ia_video_ingestion python3.6 mqtt_publish.py
    ```

## Steps to setup ETA solution on factory system (scripts hould be executed from `$GOPATH/src/<youriapocrepofolder>/docker_setup` directory)

**Pre-requisite:**
* Have the ETA images stored as tarballs from dev system: `sudo ./deploy/save_eta_images.sh`
* Create a tar ball of `/var/lib/eta` folder, this is where we have all the config files which would be mounted into containers. This needs to be copied over to the factory system along with `docker_setup` folder which has all the necessary scripts and docker images tar balls. The docker images tar balls are saved under `docker_setup/deploy/docker_images`.
    
1. Load ETA images (Input here is the ETA images tarballs)

    ```sh
    sudo ./deploy/load_eta_images.sh | tee load_eta_images.txt
    ```
    
2. Run dependency and ETA images 

	```sh
    sudo ./deploy/deploy_compose_startup.sh | tee deploy_compose_startup.txt
    ```

    **Note**: Please run `docker ps` cmd to see if all the dependency and ETA containers are up.

> Note:
> 1. ETA containers are: DataAgent(ia_data_agent), Video Ingestion(ia_video_ingestion) and Classifier(ia_data_analytics) 
> 2. Dependency containers are: Influxdb(influx_cont), Redis(redis_cont), postgres(postgres_cont) and mosquitto (mosquitto_cont)
> 3. Few useful docker-compose and docker commands:
> * `docker-compose down` - brings down the service containers
> * `docker-compose up -d` - brings up the service containers
> * `docker ps` - check running containers
> * `docker ps -a` - check running and stopped containers
> * `docker stop $(docker ps -a -q)` - stops all the containers
> * `docker rm $(docker ps -a -q)` - removes all the containers. Useful when you run into issue of already container is in use.
> **Note**: Some useful links:
> * [docker compose cli](https://docs.docker.com/compose/reference/overview/)
> * [docker compose reference](https://docs.docker.com/compose/compose-file/)
> * [docker cli](https://docs.docker.com/engine/reference/commandline/cli/#configuration-files)
4. If you want to run the docker images separately i.e, one by one, run the command `docker-compose run --no-deps [service_cont_name]` Eg: `docker-compose run --name ia_video_ingestion --no-deps ia_video_ingestion` to run VI container and the switch `--no-deps` will not bring up it's dependencies mentioned in the docker-compose file. If the container is not launching, there could be some issue with entrypoint program which could be overrided by providing this extra switch `--entrypoint /bin/bash` before ther service container name in the docker-compose run command above, this would let one inside the container and run the actual entrypoint program from the container's terminal to rootcause the issue. If the container is running and one wants to get inside, use cmd: `docker-compose exec [service_cont_name] /bin/bash` or `docker exec -it [cont_name] /bin/bash`
> 5. For debug purpose, it becomes essential to send dev team the logs of the build/run scripts to rootcause the issue effectively. This is where the `tee` command comes to rescue.
> 6. Best way to check logs of containers is to use command: `docker logs -f [cont_name]`
