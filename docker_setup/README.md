# Docker setup of ETA solution:

## Pre-requisities:
1. Install latest docker cli/docker daemon by following [this](https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-docker-ce). Follow **Install using the repository** and **Install Docker CE (follow first 2 steps)** sections there. Also, follow the manage docker as a non-root user section at [post install](https://docs.docker.com/install/linux/linux-postinstall/) to run docker without sudo
2. Configure proxy settings for docker client to connect to internet and for containers to access internet by following [this](https://docs.docker.com/network/proxy/). One can copy the below json object to ~/.docker/config.json:

    ```
    {
        "proxies":
            {
                "default":
                {
                    "httpProxy": "http://proxy.iind.intel.com:911",
                    "httpsProxy": "http://proxy.iind.intel.com:911",
                    "noProxy": "127.0.0.1,localhost,*.intel.com"
                }
            }
    }
    ```

3. Configure proxy settings for docker daemon by following the steps at [this](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy). Use the values for http proxy and https proxy as used above.

4. If you still see issues of not being able to access internet from container, please update the /etc/resolv.conf. The changes may go away after system restart, should be brought in back.
Update /etc/resolv.conf file on your host system with the following content:

    ```
    # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
    #     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
    nameserver 10.248.2.1
    nameserver 10.223.45.36
    nameserver 172.30.90.4
    search iind.intel.com
    ```
    
5. Since we are using host network namespace for containers, please make sure that individual processes/modules of ETA are stopped on host system. If they are running, the containers will fail to launch as the ports are already in use. To see if a specific port is in use, one can use this cmd:
**sudo fuser [port_no]/tcp** - it will tell the process ID using it. Also, one can use cmd: `sudo ./kill_local_dependency_eta_processes.sh` to kill all the native dependency and eta processes (**Note**: In the script, we are assuming that all the dependency processes are installed as services. If that's not the case, the onus is on you to kill the process manually)

6. In dockerized environment, it is observed that more points are received by kapacitor from influxdb. This is due to more subscriptions set on "datain" database. Please make sure to drop "datain" database before trying the docker setup OR drop the subscription. Eg: **drop subscription "kapacitor-65c392d7-6ef7-46f8-97c2-e5eeb7094c12" on "_internal"."monitor"** for _internal database.

7. Copy all the video files from "\\Vmspfsfsbg01\qsd_sw_ba\FOG\Validation\validation_videos" in the test_videos folder under the project root directory

## Steps to setup ETA solution on dev system (scripts hould be executed from `$GOPATH/src/<youriapocrepofolder>/docker_setup/scripts` directory)

1. Run dependency images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    
    ```sh
    sudo ./run_dependency_images.sh | tee run_dependency_images.txt
    ```
    
    **Note**: To check if all the dependency containers are running, use cmd: **docker ps** 
2. Build ETA images (one time task unless you change something in Dockerfile of ETA images)
    
    ```sh
    sudo ./build_eta_images.sh | tee build_eta_images.txt
    ```
    
    **Note**: To check if all the ETA images are built successfully, use cmd: **docker images|grep ia** 
3. Run ETA images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    
    ```sh
    sudo ./run_eta_images.sh | tee run_eta_images.txt
    ```

4. Triggering camera ON message to VideoIngestion module

    ```sh
    docker exec -d ia_video_ingestion python3.6 mqtt_publish.py
    ```

    
    **Note**: To check if all the eta containers are running, use cmd: **docker ps** 

## Steps to setup ETA solution on factory system (scripts hould be executed from `$GOPATH/src/<youriapocrepofolder>/docker_setup/scripts` directory)

**Pre-requisite:**
* Have the ETA images stored as tarballs from dev system: `sudo ./deploy/save_eta_images.sh`
* Create a tar ball of `/var/lib/eta` folder, this is where we have all the config files which would be mounted into containers
    
1. Load ETA images (Input here is the ETA images tarballs)

    ```sh
    sudo ./deploy/load_eta_images.sh | tee load_eta_images.txt
    ```
    
2. Run dependency images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)

	```sh
    sudo ./run_dependency_images.sh | tee run_dependency_images.txt
    ```
    
3. Run ETA images (one time task unless there is some issue with starting off any containers or you want to change docker run cmd)
    
    ```sh
    sudo ./run_eta_images.sh | tee run_eta_images.txt
    ```

4. Triggering camera ON message to VideoIngestion module

    ```sh
    docker exec -d ia_video_ingestion python3.6 mqtt_publish.py
    ```

> Note:
> 1. ETA containers are: DataAgent(ia_data_agent), Video Ingestion(ia_video_ingestion), Classifier(ia_data_analytics) and NATS client
> 2. Dependency containers are: Influxdb(influx_cont), Redis(redis_cont), nats (nats_cont), postgres(postgres_cont), mosquitto (mosquitto_cont)
> 3. Few useful docker commands:
>   	* **docker ps** - check running containers
>   	* **docker ps -a** - check running and stopped containers
>   	* **docker stop $(docker ps -a -q)** - stops all the containers
>   	* **docker rm $(docker ps -a -q)** - removes all the containers. Useful when you run into issue of already container is in use.
> 4. If you want to run the docker images separately i.e, one by one, just do **source setenv.sh** script on the terminal and then copy & run the individual **docker run** container commands with **-it** switch instead of **-d** to get to see the entrypoint program output inside the container. If the container is not launching, there could be some issue with entrypoint program which could be overrided by switch **--entrypoint /bin/bash** to get inside the container and run the actual entrypoint program from the container's terminal to rootcause the issue.
> 5. For debug purpose, it becomes essential to send dev team the logs of the build/run scripts to rootcause the issue effectively. This is where the `tee` command comes to rescue.
> 6. **Known issues as of now**: 
>    * Logs of container may not be fully available at /var/lib/eta/logs location for few containers like **ia_data_analytics_cont**.
>      Best way to check logs is to use command: **docker logs <contname>**
>    * NATS client container is not receiving published messages