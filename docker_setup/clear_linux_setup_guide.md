## Step 1 - Install Clear Linux OS
The first step is to install Clear Linux on your gateway. Follow the instructions
at [this](https://clearlinux.org/documentation/clear-linux/get-started/bare-metal-install)
link.

**IMPORTANT:** Use [version 24330](https://download.clearlinux.org/releases/24330/clear/clear-24330-installer.iso.xz) 
of Clear Linux.

## Step 2 - Install Clear Linux Bundles

1. Disable `swupd` auto update
    ```sh
    swupd autoupdate --disable
    ```

2. Double check to assure that Clear Linux version 24330 is installed
    ```sh
    swupd verify --fix -m 24330 --picky
    ```

3. Install the following Clear Linux bundles:

    * network-basic
    * openssh-server
    * os-core-dev
    * database-basic
    * dev-utils-dev
    * sysadmin-basic

    The command for installing a bundle is the following:
    ```sh
    $ swupd bundle-add network-basic openssh-server os-core-dev database-basic dev-utils-dev sysadmin-basic
    ```

4. Configure static IP address(192.168.1.x/24) on the gateway by following the instructions
    outlined [here](https://clearlinux.org/documentation/clear-linux/reference/bundles/os-core)

5. Setup the SSH server, and add SSH public key to the authorized_keys file. From all computers that you wish to ssh from, enter the following command and respond to all prompts:

    ```sh
    $ ssh-copy-id [name or IP address]
    ```

## Step 3 - Add users
1.  Add user `intel`
    ```sh
    $ sudo useradd intel
    ```

2.  Change new user's password to `intel123`. Enter the following command and responp to all prompts  
    ```sh
    $ passwd intel
    ```

3.  Configure Linux to allow user `intel` to use the sudo command:
    ```sh
    $ sudo usermod -a -G wheel intel
    ```    

4.  Optional, if located inside Intel's campus: Set up proxy (`Depending on the geo location where the system is setup, please use the proxy settings of that geo. This change may not be needed in  non-proxy environment`):

    ```sh
    $ sudo su
    $ echo "use_proxy=on 
    http_proxy=http://proxy.iind.intel.com:911 
    https_proxy=https://proxy.iind.intel.com:911" > /home/intel/.wgetrc
    $ export LINUX_USER=`whoami`
    $ chown $LINUX_USER:$LINUX_USER /home/$LINUX_USER/.wgetrc
    $ exit
    ``` 

## Step 4 - Installing docker and docker-compose tools

* Installing docker

  * Run below commands to install docker bundle. For more details, [refer](https://clearlinux.org/documentation/clear-linux/tutorials/docker#id2)

    ```sh
    sudo swupd bundle-add containers-basic
    sudo systemctl start docker
    sudo systemctl enable docker
    sudo docker version
    ```
  
  * Add `intel` user to docker group by running cmd:

    ```sh
    sudo usermod -a -G docker intel
    ```

    > **Note**: Please logout of the system and login back to run docker without `sudo`. Ensure you are able to run `docker` commands without
    > prefixing `sudo`.

  * Please follow the below steps only if the node/system on which the docker setup is tried out is running behind a HTTP proxy server. If  that's not the case, this step can be skipped.
    
      * Configure proxy settings for docker client to connect to internet and for containers to access internet by following    [https://docs.docker.com/network/proxy/](https://docs.docker.com/network/proxy/). One can copy the below json object to ~/.docker/config.json (**Note**: `Depending on the geo location where the system is setup, please use the proxy settings of that geo. This change may not be needed in  non-proxy environment`):

        ```
        {
            "proxies":
                {
                    "default":
                    {
                        "httpProxy": "http://proxy.iind.intel.com:911",
                        "httpsProxy": "http://proxy.iind.intel.com:911",
                        "noProxy": "127.0.0.1,localhost,*.intel.com"
                    }
                }
        }
        ```

      * Configure proxy settings for docker daemon by following the steps at [https://docs.docker.com/config/daemon/systemd/#httphttps-proxy](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy). Use the values for http proxy and https proxy as used above (**Note**: `Depending on the geo location where the system is setup, please use the proxy settings of that geo. This change may not be needed in  non-proxy environment`)

      * If you still see issues of not being able to access internet from container, please update `resolv.conf` file at `docker_setup/resolv.conf`. The `docker_setup/compose_startup.sh` and `docker_setup/deploy/deploy_compose_startup.sh` scripts will re-copy the resolv.conf to `/etc/resolv.conf` to keep it updated across system restarts (**Note**: `This change may not be needed in non-proxy environment`):

        ```
            /etc/resolv.conf is dynamically generated by NetworkManager.

            Comment out the line dns=dnsmasq (with a #) in /etc/NetworkManager/NetworkManager.conf

            Restart the NetworkManager to regenerate /etc/resolv.conf :
            sudo systemctl restart network-manager

            Verify on the host: cat /etc/resolv.conf
        ```

* Installing docker-compose (Have the proxy envs set in `/etc/environment` if run behind HTTP proxy server).

  Install `docker-compose` tool by following this [https://docs.docker.com/compose/install/#install-compose](https://docs.docker.com/compose/install/#install-compose)

## Step 5 - This is not needed unless one wants to install `basler-capture` natively/bare metal

### 1 - Install OpenCV 

1. Install NumPy
    ```sh
    $ pip3 install numpy
    ```

1. Clone the OpenCV Git repository
    ```sh
    $ git clone https://github.com/opencv/opencv.git
    ```

2. Checkout the 3.4.1 git tag
    ```sh
    $ git checkout tags/3.4.1
    ```

3. Compile OpenCV 3.4.1 with Python3 support
    ```sh
    $ mkdir build
    $ cd build
    $ PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/ cmake -DCMAKE_BUILD_TYPE=Release -DPYTHON3_EXECUTABLE=`which python3` -DPYTHON_DEFAULT_EXECUTABLE=`which python3` -DENABLE_PRECOMPILED_HEADERS=OFF -DCMAKE_CXX_FLAGS=-std=c++11 ..
    $ export LD_LIBRARY_PATH=/usr/local/lib; make -j8
    $ sudo make install
    ```

    > **IMPORTANT:** Do not install the OpenCV Contribs library, as it contains
    algorithms with a proprietary license, which we do not have permission
    to distribute

4. Create symbolic link
    ```sh
    $ sudo ln -s /usr/local/lib/python3.6/site-packages/cv2.cpython-36m-x86_64-linux-gnu.so  /usr/lib/python3.6/site-packages/cv2.so
    ```

#### Success Criteria
Run the Python 3 interpreter and import the OpenCV Python module successfully
(shown below).

```sh
$ python
Python 3.6.5 (default, Mar 30 2018, 06:41:53)
[GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.39.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import cv2
>>>
```
> **NOTE:** This is just example output, your actual output may vary a bit, but
no Python exceptions should be raised.


### 2 - Install `Boost` Library
1. Download [Boost 1.63.0](https://sourceforge.net/projects/boost/files/boost/1.63.0/boost_1_63_0.tar.gz) 
    ```sh
    $ wget https://sourceforge.net/projects/boost/files/boost/1.63.0/boost_1_63_0.tar.gz)
    ```
2. Untar package, change directory, and create symbolic link:
    ```sh
    $ tar -zxf boost_1_63_0.tar.gz
    $ cd boost_1_63_0
    $ sudo ln -s /usr/include/python3.6m/ /usr/include/python3.6
    ```

4. Compile and install Boost 1.63.0 with the following commands:
    ```sh
    $ ./bootstrap.sh --with-python=/usr/bin/python3
    $ ./b2 --with-python cxxflags="-std=c++11"
    $ sudo ./b2 install
    ```

### 3 - Install `basler_video_capture` Library

1. Copy the `basler_video_capture` library to the gateway
    ```sh
    $ clone https://$github.intel.com/Alibaba-Pathfinding/basler-video-capture.git
    $ tar xvf pylon-5.0.11.10914-x86_64.tar.gz
    $ cd pylon-5.0.11.10914-x86_64
    $ sudo mkdir /opt
    $ sudo tar -C /opt -zxf pylonSDK-5.0.11.10914-x86_64.tar.gz
    ```

2. Install Basler Pylon 5 SDK with the following commands:
    ```sh
    $ cd ..
    $ export LD_LIBRARY_PATH=/usr/local/lib
    $ python setup.py test
    ```

**NOTE:** Unplug all cameras before executing the previous step.  This test will fail 
          if the driver finds a camera.  If there is a camera installed, then an 
          alternate test will be to execute the following line.  If everything is
          installed, the the serial number of the camera will be displayed:
    ```sh
    $ basler-capture  enumerate
    ```

3. Provided that all tests in the prior step pass, install the library with the
    following command:
    ```sh
    $ sudo python setup.py install
    ```

#### Success Criteria
All tests pass when executing the `python setup.py test` command, and the 
installation of the `basler_video_capture` library is successful.