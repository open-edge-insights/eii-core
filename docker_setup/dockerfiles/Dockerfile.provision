# Dockerfile for DataAgent
ARG ETA_VERSION
FROM ia/gobase:${ETA_VERSION}
LABEL description="DataAgent image"

RUN mkdir -p ${GO_WORK_DIR}/log

# Installing all golang dependencies
# TODO: Use dep tool itself in future once the "source" value
# is obeyed and just "name" value is not used for deducing the
# repo (https://github.com/golang/dep/pull/1857/commits)

ENV GLOG_GO_PATH ${GOPATH}/src/github.com/golang/glog
RUN mkdir -p ${GLOG_GO_PATH} && \
    git clone https://github.com/golang/glog ${GLOG_GO_PATH} && \
    cd ${GLOG_GO_PATH} && \
    git checkout -b known_version 23def4e6c14b4da8ac2ed8007337bc5eb5007998

ENV VAULT_GO_PATH ${GOPATH}/src/github.com/hashicorp/vault
RUN mkdir -p ${VAULT_GO_PATH} && \
    git clone https://github.com/hashicorp/vault ${VAULT_GO_PATH} && \
    cd  ${VAULT_GO_PATH} && \
    git checkout -b v1.0.0-beta2 tags/v1.0.0-beta2 && \
    go install

RUN apt-get update

# Installing TPM
RUN apt-get -y install \
  autoconf-archive \
  libcmocka0 \
  libcmocka-dev \
  iproute2 \
  build-essential \
  git \
  pkg-config \
  gcc \
  g++ \
  m4 \
  libtool \
  automake \
  libgcrypt20-dev \
  libssl-dev \
  uthash-dev \
  autoconf \
  gnulib

ENV TPM_PATH ./TPM_SRC
RUN mkdir -p ${TPM_PATH}/tpm2_tss && \
    git clone https://github.com/tpm2-software/tpm2-tss.git ${TPM_PATH}/tpm2_tss && \
    cd ${TPM_PATH}/tpm2_tss && git checkout -b 2.1.0 tags/2.1.0

RUN cd ${TPM_PATH}/tpm2_tss/ && ./bootstrap &&  ./configure && make -j8 && make install

# build TPM-tool
RUN apt-get -y install autoconf automake libtool pkg-config gcc libssl-dev \
    libcurl4-gnutls-dev

RUN mkdir -p ${TPM_PATH}/tpm2_tools && \
    git clone https://github.com/tpm2-software/tpm2-tools.git ${TPM_PATH}/tpm2_tools && \
    cd ${TPM_PATH}/tpm2_tools && git checkout -b sma-pv 9f765f1959f2a4ee9683165071d05f9878d78443

RUN cd ${TPM_PATH}/tpm2_tools/ && ./bootstrap &&  ./configure && make -j8 && make install

ADD DataAgent/provision/provision_eta.go ./
ADD DataAgent/provision/provision_eta.sh ./
ADD docker_setup/provision_config.json ./config_file.json
ADD docker_setup/config/vault_config.hcl ./vault/config/vault_config.hcl
ADD Util ./Util
RUN mkdir -p ./vault/file

RUN go build -o /ETA/go/bin/provision_eta ./provision_eta.go
ENTRYPOINT ["./provision_eta.sh"]
HEALTHCHECK NONE
