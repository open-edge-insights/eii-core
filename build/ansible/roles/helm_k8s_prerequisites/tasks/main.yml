---

- name: Set Directory permission for Certificates as accesible to leader
  become: yes
  ansible.builtin.file:
    path: "{{ EII_SOURCE_PATH }}/build/provision/Certificates/"
    state: directory
    recurse: yes
    mode: '0755'
    
- name: Set Directory permission for Certificates as accesible to leader
  become: yes
  ansible.builtin.file:
    path: "{{ EII_SOURCE_PATH }}/build/provision/rootca/"
    state: directory
    recurse: yes
    mode: '0755'
    
- name: Copy Certificates to eii-helm provision
  become: yes
  shell: "cp -rf Certificates/ {{ EII_SOURCE_PATH }}/build/helm-eii/eii-provision/"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/provision/"

- name: Building ia_etcd_container
  shell: "source .env && docker-compose -f provision/dep/docker-compose-etcd.yml build"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/"
    executable: /bin/bash
  register: command_out
  when: DEV_MODE == true
  
- name: Building ia_etcd_container
  shell: "source .env && docker-compose -f provision/dep/docker-compose-etcd.yml -f provision/dep/docker-compose-etcd.override.prod.yml build"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/"
    executable: /bin/bash
  register: command_out
  when: DEV_MODE == false

- debug:
    msg: "{{ command_out.stdout }}"

- name: Building ia_etcd_provision container
  shell: "source .env && docker-compose -f provision/dep/docker-compose-etcd-provision.yml build"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/"
    executable: /bin/bash
  register: command_out
  when: DEV_MODE == true
  
- name: Building ia_etcd provision container
  shell: "source .env && docker-compose -f provision/dep/docker-compose-etcd-provision.yml -f provision/dep/docker-compose-etcd-provision.override.prod.yml build"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/"
    executable: /bin/bash
  register: command_out
  when: DEV_MODE == false

- name: docker login
  shell: "docker login {{ docker_registry }} -u {{ docker_login_user }} -p {{ docker_login_passwd }}"
  register: command_out
  when: docker_registry != "" and docker_login_user != "" and docker_login_passwd != ""

- debug:
    msg: "Status of docker login, {{ command_out.stdout }}"
  when: docker_registry != "" and docker_login_user != "" and docker_login_passwd != ""

- debug:
    msg: "Push images to the docker_registry will take some time"
  when: docker_registry != ""

 
- name: Pushing ia_etcd_container to docker registry
  shell: "source .env && docker-compose -f provision/dep/docker-compose-etcd.yml build"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/"
    executable: /bin/bash
  register: command_out
  when: docker_registry != ""

- debug:
    msg: "{{ command_out.stdout }}"

- name: Pushing ia_etcd_provision container to docker registry
  shell: "source .env && docker-compose -f provision/dep/docker-compose-etcd-provision.yml push"
  args:
    chdir: "{{ EII_SOURCE_PATH }}/build/"
    executable: /bin/bash
  register: command_out
  when: docker_registry != ""

- debug:
    msg: "docker push containers {{ command_out.stdout }}"
  when: docker_registry != ""
