# EII provision and deployment  


For deployment of EII, helm charts are provided for both provision and deployment.

> **Note**:
> Only video pipeline components are enabled with the current version of deployment helm chart.

## Pre requisites

For preparing the necessary files required for the provision and deployment, user needs to execute the build and provision steps on an Ubuntu 18.04 machine.
Follow the Docker pre-requisites, EII Pre-requisites, Provision EII and Build and Run EII PCB video/timeseries use cases steps (Section 1 - 5) mentioned in [README.md](../../../README.md) on the Ubuntu dev machine.

  > **Note**:
  > While running the eii_builder, use the video-streaming.yml file with Visualizer application removed. This is to maintain parity with the video pipeline components enabled with the deploy helm charts.

  > Use the DOCKER_REGISTRY param in the .env to set the registry to push the images.

  > Provisioning step can be done for a normal single node deployment without k8s. This step is executed only for getting the Certificates generated.

## Push containers to docker registry

Push the video pipeline containers to the registry:
```sh
$ docker-compose push ia_video_ingestion ia_video_analytics ia_web_visualizer ia_etcd_ui
```

Tag and push the provisioning containers to registry:
```sh
$ set -a
$ source [WORKDIR]/IEdgeInsights/build/.env
$ set +a
$ docker tag ia_etcd:$EII_VERSION $DOCKER_REGISTRY/ia_etcd:$EII_VERSION
$ docker tag ia_etcd_provision:$EII_VERSION  $DOCKER_REGISTRY/ia_etcd_provision:$EII_VERSION 
$ docker push $DOCKER_REGISTRY/ia_etcd:$EII_VERSION  $DOCKER_REGISTRY/ia_etcd_provision:$EII_VERSION 
```

## Update the helm charts directory

1. Update the registry url to the registry param in values.yml in eii-provision/ and eii-deploy/ helm charts.
2. Copy the docker-compose.yml, eii_config.json into the eii-provision helm chart.
  ```sh
  $ cd [WORKDIR]/IEdgeInsights/build
  $ cp docker-compose.yml provision/config/eii_config.json k8s/helm-eii/eii-provision/
  ```
3. Copy the Certificates generated by provisioning process to the eii-provision helm chart.
  ```sh
  $ cd [WORKDIR]/IEdgeInsights/build
  $ sudo chmod -R 755 provision/Certificates/
  $ cp -a provision/Certificates/ k8s/helm-eii/eii-provision/
  ```
  > **Note**:
  > The Certificates/ directory contains sensitive information. So post the installation of eii-provision helm chart, it is recommended to delete the Certificates from it.

## Provision and deploy in the kubernetes node.

Copy the helm charts in helm-eii/ directory to the node.

1. Install provision helm chart
  ```sh
  $ cd helm-eii/
  $ helm install eii-provision eii-provision/
  ```

  Verify the pod is in running state:
  ```sh
  $ kubectl get pods

  NAME                       READY   STATUS    RESTARTS   AGE
  ia-etcd-58866469b9-dl66k   2/2     Running   0          8s
  ```

2. Install deploy helm chart
  ```sh
  $ cd helm-eii/
  $ helm install eii-deploy eii-deploy/
  ```

  Verify all the pod are running:
  ```sh
  $ kubectl get pods

  NAME                                          READY   STATUS    RESTARTS   AGE
  deployment-etcd-ui-6c7c6cd769-rwqm6           1/1     Running   0          11s
  deployment-video-analytics-546574f474-mt7wp   1/1     Running   0          11s
  deployment-video-ingestion-979dd8998-9mzkh    1/1     Running   0          11s
  deployment-webvisualizer-6c9d56694b-4qhnw     1/1     Running   0          11s
  ia-etcd-58866469b9-dl66k                      2/2     Running   0          2m26s
  ```

The EII is now succesfully deployed and the web visualizer can be accessed.

## Provision and deploy in DEV mode

Below changes need to be done for deploying the EII applications in DEV mode

1. Set the dev_mode as "true" in  eii-provision/values.yaml and eii-deploy/values.yaml.

2. Remove the etcd storage directory
  ```sh
  $sudo rm -rf /opt/intel/eii/data/*
  ```
Do helm install of provision and deploy charts as per previous section.