version: '3.6'

services:
  ia_gobase:
    build:
      context: ./
      dockerfile: $PWD/../../docker_setup/dockerfiles/Dockerfile.gobase
      args:
          UBUNTU_IMAGE_VERSION: ${UBUNTU_IMAGE_VERSION}
          HOST_TIME_ZONE: ${HOST_TIME_ZONE}
    image: ia_gobase:${IEI_VERSION}

  # Define ia_pybase service
  ia_pybase:
    build:
      context: ./
      dockerfile: $PWD/../../docker_setup/dockerfiles/Dockerfile.pybase
      args:
          UBUNTU_IMAGE_VERSION: ${UBUNTU_IMAGE_VERSION}
          IEI_VERSION: ${IEI_VERSION}
    image: ia_pybase:${IEI_VERSION}

  # Define ia_gopybase service
  ia_gopybase:
    build:
      context: ./
      dockerfile: $PWD/../../docker_setup/dockerfiles/Dockerfile.gopybase
      args:
        IEI_VERSION: ${IEI_VERSION}
    depends_on:
      - ia_gobase
      - ia_pybase
    image: ia_gopybase:${IEI_VERSION}

  ia_zmq_pub:
    build:
      context: ../
      dockerfile: $PWD/dockerfiles/Dockerfile.zmqpub
      args:
        IEI_VERSION: ${IEI_VERSION}
    image: ia_zmq_pub:${IEI_VERSION}
    network_mode: host
    container_name: ia_zmq_pub
    hostname: ia_zmq_pub
    environment:
      no_proxy: ${NO_PROXY}
      pub_topic: "camera1_stream"
      camera1_stream_config: "ZeroMQ/TCP,*:5563"
    depends_on:
      - ia_gopybase
    secrets:
      - zmq_client.key_secret
      - zmq_server.key_secret
      - etcd.ca.cert
      - etcd.client.cert
      - etcd.client.key
      - etcd.server.cert
      - etcd.server.key

  ia_zmq_sub:
    build:
      context: ./
      dockerfile: $PWD/dockerfiles/Dockerfile.zmqsub
      args:
        IEI_VERSION: ${IEI_VERSION}
    image: ia_zmq_sub:${IEI_VERSION}
    network_mode: host
    container_name: ia_zmq_sub
    hostname: ia_zmq_sub
    environment:
      no_proxy: ${NO_PROXY}
      sub_topic: "camera1_stream"
      camera1_stream_config: "ZeroMQ/TCP,localhost:5563"
    depends_on:
      - ia_zmq_pub
    secrets:
      - zmq_client.key_secret
      - zmq_server.key_secret

  ia_etcd:
    build:
      context: ../
      dockerfile: $PWD/dockerfiles/Dockerfile.etcd
    image: ia_etcd
    container_name: ia_etcd
    network_mode: host
    secrets:
      - etcd.ca.cert
      - etcd.client.cert
      - etcd.client.key
      - etcd.server.cert
      - etcd.server.key

  ia_zmq_rep:
    build:
      context: ../
      dockerfile: $PWD/dockerfiles/Dockerfile.zmqrep
      args:
        IEI_VERSION: ${IEI_VERSION}
    image: ia_zmq_rep:${IEI_VERSION}
    network_mode: host
    container_name: ia_zmq_rep
    hostname: ia_zmq_rep
    environment:
      no_proxy: ${NO_PROXY}
      connection_config: "ZeroMQ/TCP,*:5563"
    depends_on:
      - ia_gopybase
    secrets:
      - zmq_client.key_secret
      - zmq_server.key_secret
      - etcd.ca.cert
      - etcd.client.cert
      - etcd.client.key
      - etcd.server.cert
      - etcd.server.key

  ia_zmq_req:
    build:
      context: ./
      dockerfile: $PWD/dockerfiles/Dockerfile.zmqreq
      args:
        IEI_VERSION: ${IEI_VERSION}
    image: ia_zmq_req:${IEI_VERSION}
    network_mode: host
    container_name: ia_zmq_req
    hostname: ia_zmq_req
    environment:
      no_proxy: ${NO_PROXY}
      connection_config: "ZeroMQ/TCP,localhost:5563"
    depends_on:
      - ia_zmq_rep
    secrets:
      - zmq_client.key_secret
      - zmq_server.key_secret

secrets:
  zmq_client.key_secret:
    file: ./py/test/private_keys/client.key_secret
  zmq_server.key_secret:
    file: ./py/test/private_keys/server.key_secret
  etcd.ca.cert:
    file: ./etcd_certs/ca.pem
  etcd.client.cert:
    file: ./etcd_certs/etcd-client.pem
  etcd.client.key:
    file: ./etcd_certs/etcd-client-key.pem
  etcd.server.cert:
    file: ./etcd_certs/etcd-server.pem
  etcd.server.key:
    file: ./etcd_certs/etcd-server-key.pem